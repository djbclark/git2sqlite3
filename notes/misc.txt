sqlite3 -init sqlite3-init-for-big-csv-import.txt ganalyze.db

DROP TABLE IF EXISTS gitreponame;
CREATE TABLE gitreponame(gmark INTEGER, ghash TEXT, gfile TEXT);
.mode csv
.import gfe.csv gitreponame
ANALYZE gitreponame;
CREATE INDEX gitreponame_index_gmark ON gitreponame(gmark,ghash,gfile);
CREATE INDEX gitreponame_index_ghash ON gitreponame(ghash,gfile,gmark);
CREATE INDEX gitreponame_index_gfile ON gitreponame(gfile,ghash,gmark);
ANALYZE gitreponame; 

-- Then start up without sqlite3 without 
-- "-init sqlite3-init-for-big-csv-import.txt" and do:
PRAGMA integrity_check(1);

~~~~~~~~~~~~ philip.greenspun.com/sql/index.html ~~~~~~~~~~~~

-- If you are working with something imported to git, there may
-- be a need to massage stuff due to branch names being in the
-- folder hierarhy. Here's an example...

BEGIN;
CREATE TEMP VIEW qnx_view AS
SELECT rowid AS rowid,
       substr(gfile, 1, pos-1) AS qbranch,
       substr(gfile, pos+8) AS qfile
FROM
  (SELECT *, rowid,
          instr(gfile,'/pkgsrc/') AS pos
   FROM qnx);
ALTER TABLE qnx ADD COLUMN qbranch TEXT;
ALTER TABLE qnx ADD COLUMN qfile TEXT;
UPDATE qnx
SET qbranch = (SELECT qbranch
               FROM qnx_view
               WHERE rowid = qnx.rowid),       
     qfile  = (SELECT qfile
               FROM qnx_view
               WHERE rowid = qnx.rowid);
DROP VIEW qnx_view;        
COMMIT;

CREATE INDEX qnx_index_qbranch ON qnx(qbranch,qfile,gfile);
CREATE INDEX qnx_index_qfile ON qnx(qfile,qbranch,gfile);
ANALYZE;

CREATE VIEW qnx_latest_view AS
SELECT rowid AS rowid,
       MAX(gmark) AS gmark, 
       ghash AS ghash, 
       qfile AS qfile
FROM qnx 
WHERE ghash NOT IN (SELECT ghash FROM pkgsrc) 
GROUP BY qfile;

CREATE VIEW pkgsrc_ancestor_view AS
SELECT rowid AS rowid,
       MAX(gmark) AS gmark,
       ghash AS ghash, 
       gfile AS gfile
FROM pkgsrc 
WHERE gfile IN (SELECT qfile FROM qnx_latest_view) 
GROUP BY gfile;

CREATE VIEW qnx_only_view AS
SELECT qnx_latest_view.gmark AS gmark, 
       qnx_latest_view.ghash AS ghash, 
       qnx_latest_view.qfile AS qfile
FROM qnx_latest_view LEFT JOIN pkgsrc_ancestor_view 
ON qnx_latest_view.qfile = pkgsrc_ancestor_view.gfile
WHERE pkgsrc_ancestor_view.gfile IS NULL
ORDER BY qnx_latest_view.qfile;

-- cd HEAD_660/pkgsrc
-- find * -type f > ../ffind.csv
-- sqlite3 ganalyze2.db

CREATE TABLE HEAD_660(ffile TEXT);
.mode csv
.import ffind.csv HEAD_660
CREATE INDEX HEAD660_index_ffile ON HEAD_660(ffile);
ANALYZE HEAD_660;

CREATE VIEW qnx_head660only_view AS
SELECT qnx_only_view.gmark AS gmark, 
       qnx_only_view.ghash AS ghash, 
       qnx_only_view.qfile AS qfile
FROM qnx_only_view JOIN HEAD_660 
ON qnx_only_view.qfile = HEAD_660.ffile
ORDER BY qnx_only_view.qfile;

CREATE VIEW qnx_head660latest_view AS
SELECT qnx_latest_view.gmark AS gmark, 
       qnx_latest_view.ghash AS ghash, 
       qnx_latest_view.qfile AS qfile
FROM qnx_latest_view JOIN HEAD_660 
ON qnx_latest_view.qfile = HEAD_660.ffile
ORDER BY qnx_latest_view.qfile;

CREATE VIEW pkgsrc_head660ancestor_view AS
SELECT rowid AS rowid,
       MAX(gmark) AS gmark,
       ghash AS ghash, 
       gfile AS gfile
FROM pkgsrc 
WHERE gfile IN (SELECT qfile FROM qnx_head660latest_view) 
GROUP BY gfile;


                   HEAD_660:    75671
                        qnx:   905189
                     pkgsrc:   838525
                
                
       qnx_head660only_view:      240   # Never in main pkgsrc      
pkgsrc_head660ancestor_view:   +  829   # Latest pkgsrc ancestor found
                               ------
     qnx_head660latest_view:     1069
  
  
              qnx_only_view:      467
       pkgsrc_ancestor_view:   + 1143
                               ------
            qnx_latest_view:     1610


-- Should just use this against the latest checkout # Never in main pkgsrc
CREATE VIEW files_to_copy AS
SELECT qfile FROM qnx_head660only_view ORDER BY qfile;

-- Need to cherrypick the below from git pkgsrc repo # Latest pkgsrc ancestor found
CREATE VIEW files_to_diff AS
SELECT gfile, ghash FROM pkgsrc_head660ancestor_view ORDER BY gfile;

