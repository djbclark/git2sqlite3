sqlite3 -init sqlite3-init-for-big-csv-import.txt ganalyze.db

DROP TABLE IF EXISTS gitreponame;
CREATE TABLE gitreponame(gmark INTEGER, ghash TEXT, gfile TEXT);
.mode csv
.import gfe.csv gitreponame
ANALYZE gitreponame;
CREATE INDEX gitreponame_index_gmark ON gitreponame(gmark,ghash,gfile);
CREATE INDEX gitreponame_index_ghash ON gitreponame(ghash,gfile,gmark);
CREATE INDEX gitreponame_index_gfile ON gitreponame(gfile,ghash,gmark);
ANALYZE gitreponame; 

-- Then start up without sqlite3 without 
-- "-init sqlite3-init-for-big-csv-import.txt" and do:
PRAGMA integrity_check(1);

~~~~~~~~~~~~ philip.greenspun.com/sql/index.html ~~~~~~~~~~~~

-- If you are working with something imported to git, there may
-- be a need to massage stuff due to branch names being in the
-- folder hierarhy. Here's an example...

BEGIN;
CREATE TEMP VIEW qnx_view AS
SELECT rowid AS rowid,
       substr(gfile, 1, pos-1) AS qbranch,
       substr(gfile, pos+8) AS qfile
FROM
  (SELECT *, rowid,
          instr(gfile,'/pkgsrc/') AS pos
   FROM qnx);
ALTER TABLE qnx ADD COLUMN qbranch TEXT;
ALTER TABLE qnx ADD COLUMN qfile TEXT;
UPDATE qnx
SET qbranch = (SELECT qbranch
               FROM qnx_view
               WHERE rowid = qnx.rowid),	   
     qfile  = (SELECT qfile
               FROM qnx_view
               WHERE rowid = qnx.rowid);
DROP VIEW qnx_view;		   
COMMIT;

CREATE INDEX qnx_index_qbranch ON qnx(qbranch,qfile,gfile);
CREATE INDEX qnx_index_qfile ON qnx(qfile,qbranch,gfile);
ANALYZE;

CREATE VIEW qnx_latest_view AS
SELECT rowid AS rowid,
       MAX(gmark) AS gmark, 
	   ghash AS ghash, 
	   qfile AS qfile
FROM qnx 
WHERE ghash NOT IN (SELECT ghash FROM pkgsrc) 
GROUP BY qfile;

CREATE VIEW pkgsrc_ancestor_view AS
SELECT rowid AS rowid,
       MAX(gmark) AS gmark,
	   ghash AS ghash, 
	   gfile AS gfile
FROM pkgsrc 
WHERE gfile IN (SELECT qfile FROM qnx_latest_view) 
GROUP BY gfile;

CREATE VIEW qnx_only_view AS
SELECT qnx_latest_view.gmark, qnx_latest_view.ghash, qnx_latest_view.qfile
FROM qnx_latest_view LEFT JOIN pkgsrc_ancestor_view 
ON qnx_latest_view.qfile = pkgsrc_ancestor_view.gfile
WHERE pkgsrc_ancestor_view.gfile IS NULL
ORDER BY qnx_latest_view.qfile;

NEXT: Only important thing left out: Just a table of all current HEAD_660 files (instead of sparse version already included in qnx table), then use that to whittle down final data set, which will be a join of (views along the lines of) qnx_latest_view and pkgsrc_ancestor_view